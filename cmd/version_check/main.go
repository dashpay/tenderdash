package main

import (
	"context"
	"fmt"
	"os"
	"strings"
	"time"

	"github.com/Masterminds/semver/v3"
	"github.com/sasha-s/go-deadlock"

	"github.com/dashpay/tenderdash/crypto/ed25519"
	"github.com/dashpay/tenderdash/internal/libs/sync"
	"github.com/dashpay/tenderdash/internal/p2p"
	"github.com/dashpay/tenderdash/internal/p2p/conn"
	"github.com/dashpay/tenderdash/libs/log"
	"github.com/dashpay/tenderdash/types"
	"github.com/dashpay/tenderdash/version"
)

// curl -s https://mnowatch.org/json/?method=emn_details | jq -r '.[] | "tcp://\(.platformNodeID)@\(.ip):\(.platformP2PPort)#\(.protx_hash)"'
//
//go:generate bash -c 'echo const hosts=\`; curl -s https://mnowatch.org/json/?method=emn_details | jq -r ".[] | \"tcp://\(.platformNodeID)@\(.ip):\(.platformP2PPort)#\(.protx_hash)\""; echo "\`" '
const hosts = `tcp://ee9ab93559e6e931d7dbcf269e1ea8446e7068e5@149.28.241.190:26656#3e596421618da23ec6700771c2f4cf819fd9ddec753f7889c96f7d1ecb6f9c40
tcp://05a7ef684955d80b7d678d4e9b6ae7eedf1eb37a@216.238.75.46:26656#9a8aa10f1b62a4dae39e173c21995395c0b5ae33a708d0c1faa8188ea17cdc20
tcp://3ed7bb4f1ed2f19cacd33f44a68b95d3f24cf85d@134.255.182.186:26656#9e3ff349fbe7944a99b77764f7d03a3d765ce669bc3c07637014c683ce324cc0
tcp://8c18b7bcfc8398e55deef029c618741206477f8b@5.161.49.32:26656#23a697e38591825c2fa01c36a6934610fac8194ba1a8fcfc6629229fe6f7fe00
tcp://451c824fb0d37abe2381d3a2753ceb8659f7e965@185.217.127.139:26656#8da027b6f709c174da865c86c77877cebf75432b419b99575684cfce0e842220
tcp://1a872dde6185341cdc5c16f5f5a6b6d2f328ea77@66.245.196.52:26656#03e0ac65173d68075ce818dbf01c7b46fc8e9b1d242a3a4bf732ae6ce6471a80
tcp://@51.83.234.203:#e7ea6db743a83a34825d0958c7366ddd80053d7e97232597f81f8e0d85570b20
tcp://78c898f1fb4e72686b0d8e51e8aba5910d79708d@109.199.122.22:26656#9c55a18619ad89c1498139bb370ae68665ee68d95a113326687375dbeed80b20
tcp://@178.157.91.186:#8b447ad22f5068a9f7fdd46a3aa09387d53933f56b9d625d0c1981888a92afe0
tcp://02b224f5d774e0457ab638300c2ec2a6198fc4ee@188.225.11.5:26656#7ffec5def480d757a2724367db6c822ab094c736ea8c0d0af1bc914e036a1701
tcp://b286af9b51d117c77f740f310a58ec00c8e84730@80.147.135.74:26656#3ebb34aed273c071e94daa550afca608682c5694bbf43bafb3926ed7d5976061
tcp://02f5a88685f5e1d7590d76551e6cf2f7b5229453@157.66.81.162:26656#fb039ef63df8d1989aec4f87b728e7179bade6d1b429ab0c952d541c66eef4c1
tcp://5e56408e077c1e664c4c6a6f632211f649b72026@213.199.34.250:26656#8bd1644adacb12968a913781ec7c5d6ae7ba1d9b6a65217cf45c900ef8053181
tcp://040e8c9cd139365d2cebdbc76769a0748bacd7da@146.59.6.50:26656#c646cdbf76e5d5b77ef99f3806b23bbffe885985d0bce82b3259742048bd55e1
tcp://@178.157.91.176:#ffb44ddfe12fd80c16fe61d6bce14e15bf0b1692e586b6c4c49651afc938b781
tcp://157f4491a923c8ab3314adb195b3322331c43007@157.90.238.161:26656#7494ab33759421b6e04e52a664665c55d279a70a06b07b68a6356dda2ea54b81
tcp://2e3090a4ac86075e0b9fee5013d0cef6604bdab8@185.198.234.68:26656#1133198f95fc0c393d5ca530bf6de45f143abbd9d849933cefe0abfae32cf002
tcp://438bac9b94613f8eafc8a9d5b8dc73ea65afb658@37.60.236.212:26656#e3b68ab54c808c5386e34babdc29dcf7a219a426c307eba15196228016e44862
tcp://5d2ec3f62d98bb0d6e3a8d7c9076d7e9bd45774f@51.68.47.136:26656#13f27e0eb9125fae027ec5d3ffbca00ee7ab1abfc778d13891c1595ea0db6542
tcp://8922664206817dd1c46572c03595d2db0fe52d75@207.244.247.40:26656#b41591cf598c31fb6f5f6ee1c0c7fc18fe0296b2ab4fdb4221f8d83b52c7d9e2
tcp://5b263589cf996af20ff58570142864041a986e33@51.195.91.9:26656#101301a6b8fe9474c7647f51509f0bd90b3ba3d6022cf7c09cb9bccc3ecdae02
tcp://698a5edb33ce2df236a4db13d35cc384423f8fce@45.32.70.131:26656#a61da3f47bf21d005f64fbf729dfb832422b5ccac2c5b8173ad17f334e15aa42
tcp://8eb2614b645e686df7dab0171f81754398b33170@52.33.9.172:26656#ee22f5bce3b6f8734a664ba7be36b1bab218eda764136691e8b506003a7bb662
tcp://54c30273d72752d4953d81ceb0e92c0b313902a9@185.158.107.124:26656#e8519e0a0dde718c3d3ab7a0850855499dfaef6a7881487ce91c9d5f1e6fbee2
tcp://2d482f769f0261cdb669356a478c9991b04392a7@185.198.234.17:26656#4b9e75808b451aa192e1bd448971192bd5ab9f8ec1790b6535d845aef57e4b22
tcp://c7f4e296e00349967e41b67d9e9bff82d2bfcb21@147.135.199.138:26656#52fc4d740991fa557c439a5d553ba0bd71f84675f41268568c33158be6405f22
tcp://0f12674271d764f7f454f0184860554b1c271ef5@93.190.140.101:26656#57eb2627121afff87b1378dedef3b4b36984821316ed720ebc9a7beb557ee722
tcp://6b7dc37855715348a9b1cf300a25a78d5ffaa50b@194.146.13.7:26656#79cccdfb7514e5f197541dc6662b29d122660e91a3059d13cf7b3e0c05550403
tcp://d80a1d13b6e11327c3e289b08d9b9e4f11e93dbd@93.190.140.112:26656#ed2a0d621c834b3c0652d8e6ad8265a971e8847766f40af13b8d3413123d8d23
tcp://f81487f965ebbe4f2b8976ae088243b2bdefdd3a@38.242.253.223:26656#1022cecbba9519cc6ae5dcda5d34c9215310d9ddab3f73cb46d332a409e4e5a3
tcp://b47f61a0f00f1e0b7f4315d476ea5319844df0b8@65.108.74.95:26656#79f6b7508b8982b883ea1a6e6657e005fc751729bd6ebefae6d5b012c3661323
tcp://e03427469bc980bddf2722ff8c637452091e942a@44.240.99.214:26656#876b7fdfc60b90fd2d549c55cf52df787b1bbd80c1932c886711609fbb3ba404
tcp://ed91d591060eda45175256129df5a532ceb5bb2c@5.75.133.148:26656#f1cc3940e4ed45d1ca63491008127a66749efe1be782586a039f36c6e2949c24
tcp://4176ec928ff0499a7bc7089ea0ff00966eddb3c2@38.242.233.166:26656#9e83857d3a8f031c627dd75325af3a07ff09d3cfde7e9151550537421f50cc84
tcp://1da35899a34a86efc74ce21df967a1d462f22534@51.195.118.43:26656#3abc901c870c1b808fe672ff3aaecf282c0f2b2a41ec40fc991cb93bc19ae8a4
tcp://b96f7087d1ca66cf0a4179a56ab064e231aef9eb@192.248.178.237:26656#174defd7f00894efa75a025315106960e5538a62112d9850f6f1b2940446c2a4
tcp://2f8124efae8910b4701aa4ec53bc348211ffdb8a@95.179.159.65:26656#936876aea72924467daa99a22205e3d94462b9cae824e4127ef1d554f397d6e4
tcp://b2924bb0962e92f2fb6a60d24425949e8afb4274@2.58.14.149:26656#1dbcaa3b1cf12c0dfcdb3cd28e50af4f231ca94d7d98e5eaf2e730cd357a7d05
tcp://3719ae172b2bea2e56003897dc4aa0ec27063658@139.84.232.129:26656#3ee1ba80075c803eaf8ca2d44b2215c95285c8bc73a8ea7bc697a802b5ff9e85
tcp://a7a860c93084db15e3cabf9918a561ce5e637f70@37.60.243.119:26656#f177beb400c4b84330c6e14a058c76f8319c21a4f7aefbab2ba73c8fe389cea5
tcp://@167.172.178.124:#520ee1b4d54872839abbab97b56f0f2b8dea9e56ffbca131c9724c3dbeeceb25
tcp://f7d67ae968ac7bb19cb7146029bec18498f2941c@194.195.87.34:26656#5c8b0881a67c1d164ed343095554c73b986d37004f941d476889f5a0c3c0e0a6
tcp://7b6853808c0b720112a005c4ffe6db4e2758f428@46.254.241.7:26656#d23104cb8d1019500523e8dab780b9635a7a2e9e48779d62063cd1053db2f4c6
tcp://b9bbd514bcb04bd7b8aa1ab2cb48c1526ff6e83d@161.97.160.92:26656#dab0d9af2d70e59ffdf3bfe375c6e9f3d185d2527c0842c7bf2815798a166526
tcp://6434a484a582b49202f89f2e0010e174ca65d612@65.108.246.145:26656#5f0f9700d4e6c9ced64ad672d88b0c021ab9d8caa94c2500cc2cb70228c5cec6
tcp://e37f885cc6acf832d40aef3014684d54b82696bd@64.176.10.71:26656#8c618567caeb7ab661cecdf6a551238ec42e602c73bc65a6bec9db5f91d2af06
tcp://e9b9d6ac2a0e664c265c02579ffe4e95a70810fa@158.247.247.241:26656#8bc76ca7a979ded6171e6a0bd9bd2a43dfa052e7b54b092d9862db52efe38726
tcp://@164.90.161.77:#3b993d6f7c707e5083a7d3d5cee94ae50bda4afae0e7a4612e88585e05741386
tcp://c0631ae5cb9c12bcfecb94dafefa59803eb5169b@37.60.244.220:26656#0d04d0b12b9c2d3cdffc3e4a59b8ef0e1cc5b165e51c1ad44ee8afed418573e6
tcp://b439f25abe95293c1b25eaa1319309a9696417a6@2.58.82.231:26656#47b1197bca506b44aca384ab8df5edc43906f3f3e3a05a2ff35f3b2e6550d427
tcp://6d9c81386f0807c90ccd42e735c0176eb64163a8@139.180.143.115:26656#e4bb242753bad98939b0174a1b3354455e57a944abe77e8cc208435ad68cb8a7
tcp://ac3165ceb67f2204d712bfe21ade940158228808@185.198.234.54:26656#5bd3e0d5483c632e3cc01a1b4383a3d19ec7a5327eaef851dd438f5448731cc7
tcp://be8ca0d8e02093a413e6b8e56b8009f319622032@213.199.44.112:26656#feeeba72d96bba076b65f350c48fa03484676e5e1ae3c5b0f2bfd869a690aa87
tcp://ce7cd7d6f3710f36c37f94869d5930829c3c28c2@134.255.182.185:26656#fc08e30e64483af9fb1190ad17386dbccaf378daf9f4accbf26bef12d0d55508
tcp://@91.199.149.177:#c06ab623ce5fa91d5862f260d702e1d2bbd85dbcd8698834affccd5f5d48b188
tcp://f6b7ef5f0d757ef8495a5661e7f3cc7e42e38c64@51.77.194.69:26656#6534b58e8a1c39b3d56a6af2fea0781ab48b2076febc6ccba6efaad6ee46b268
tcp://2797c7b9fbe488eb7761f2cc650650c193658e77@139.84.137.143:26656#35978e1a9095afc9dcd72925a001b8b38331154fa2acaa7d2b00d6f81165d2e8
tcp://@5.132.162.135:#85f66efab1cdfbba29a7ace3afa2ba2d429aaa082c8ecd925cf6d9e40edfff08
tcp://38717918e719702f18e8f6369e279a6baba94f1d@51.195.91.7:26656#a3212bb52d08b098aa4a65b0cd502fc2c87a8e78f987b3e98c16b769c72c1b08
tcp://c579df7fdd61cc77e65a8e61ad30b048b33a8586@173.212.239.124:26656#2583ef29dc8b29ce32c5cbd21b88c90c9c9ff0225de7fad9d6c83c0e1cd324a9
tcp://580b5c1c11f2f71ea589f232b17e622f723aa168@157.10.199.77:26656#ca29b00eab6ac180c70a9d1260dac7e2018688a5450c802028fd5da1dc5bca89
tcp://7764cb891526567c8035fd99c9e04c7265b83386@5.189.186.78:26656#06a9ee248111bf6d6d5b123cc40b3a9c9c9c3c84a58e5a2ed9df97ad7c4e7289
tcp://46941c00a9f138be1072184f6431e5110e32ccf4@139.84.170.10:26656#a20f3edb99394ad9d93997567599baac88abe28992276b602bea48d5eb4fc2a9
tcp://f0775fc0b031166b708620fec1535b7f13a2e1d4@173.249.53.139:26656#74a08086d3bf920c0e56748bf2d0cfed1419f251d598fdcfad1213391d23db09
tcp://c1161c96de3dae28cd7f20ff8c2aa7b94b866d76@37.60.236.151:26656#698733bb0872c94a08cc02df294e106c542dbd2dc0393c34aa71bbdfa5583329
tcp://138231a9eaaf7330bdd1a5a2f93502d1482895bb@109.199.123.12:26656#8dc85b5b4d6f424eab1f23fd8a7d9340ecea1a74f3e6d98debaa98251774f3a9
tcp://@94.130.229.10:#108a0089ad01e99ece7cddff0252984e9ffcc935bd475bb30461e0f9aac6944a
tcp://d38e79013d1ec68b40d357010c753828f0ff41ad@128.140.107.66:26656#41c2796506348522794b000a5a7d24e2b2395c6fa856cfafedad3dbe564f108a
tcp://@212.110.204.82:#79be053ec691833f2941b96eddf41c4092ffd1b3b48c4a72502a9ff40cab0eca
tcp://@164.90.171.53:#72c3ef1099ef2dc75ea3d41b792492ca13439dd5375808fcd5f0cbc9e6b23c0b
tcp://50d847734406592420320c864eb572fb900e5c36@37.27.67.159:26656#07bffaa884f78cfb549d6557065d01a5c537b39434b2b2767a6114e5d9d73ccb
tcp://6f020c24d5c7fbb99d9d371dc6ffa02ab67e7208@104.200.24.196:26656#5422f2847c2884ca2594f29c54f8fbef2c8f542e128f726f6ec8efa18fdc512b
tcp://d39a5910da39049774bad4542bca59dcf53ced37@37.60.236.225:26656#aaa0dddee42cad41c5dbc71174ba93d1ac3aab8a46db047c2786310b3d06298b
tcp://3b6f7a39a99f27ca34188e31e26e2c7c1b2686b4@172.104.90.249:26656#36d014b83c54f35061dcc08178315fca46c951ffa6c606e2c0ac3222bb0d01eb
tcp://cef856f6b2d36b70514d1f97d6c5a28aa46515f3@57.128.212.163:26656#3b08c9c6b92d3258d0f6fb93bdc593dd9a930b9bdc76bebe8c076338a060b30b
tcp://46d906f9f489418d20b00a090801fb3a0c68cb14@37.60.236.249:26656#31ce7e11cbcaf8596dfb73a68dd7bed15dff54d513896ce5682faa7e991267cb
tcp://7172633faa7bdf288c4b31e804c80f7c04670387@185.198.234.25:26656#9669de13a19f9b17e505c7220ea91bba016a39f836d0b74dae97be2f1a52a1ec
tcp://cad456489cb1ba5ded04d81070d41f7f2cd3e98d@134.255.183.250:26656#7a26c877c1e2dafea292b54ae37c39be5c51f27b24fd7a1e5a634523b5526eac
tcp://570d765b5e1197e04db99941a5e50b63b909e3fd@185.192.96.70:26656#8185dd58f231dd9e26491667f29b0438a94849f0883b88d518a7b00588312bac
tcp://383b1fa4465544fca2c100bd2353d6f746a535eb@134.255.183.248:26656#c3a213b255a6321c441fa6edd0c6c47c774733c946a6fa619910b825226ecbcc
tcp://938617eee09616c71a01d53b4a9cd16facc55185@158.220.87.55:26656#620ea4839737e145529f392cf1844398188c1e2ce02875038c22d2253415906d
tcp://3d3c81106601401c3a4a23bba7be6f4822a649a9@158.220.80.235:26656#086ac1966c3c1bcc66398fca29d85386bb8a1cf9e269d05e4f0a71fe876f690d
tcp://d5fded25644535a0e80930a4b7a89d3706b0b8a4@161.97.160.87:26656#7457a10b5a1ca0088d2c5d381d1e41dd736b05b6f44588e8f94a1592109ed12d
tcp://e6e3c3b3b6e652076e7863934ae940b3a801b6cd@134.255.183.247:26656#16cd333a82c35b71829ad096866f7a0925f9b5350624c1649389ed5f73de25ad
tcp://ce03948dd38c60d45da9fac1d24de40173342202@49.13.28.255:26656#88f021c8a3d7b4997c8947eb921f23b8d4e293664cf680e1807c34047a0a5a8d
tcp://b4d5b3b4974b81d363c124c25eb49710fa95e9e2@168.119.102.10:26656#64fe8c60e2e4e47f6ab6f34368f2a297174e79074de25c7a3222b05d7502a36d
tcp://a1332f0e07d66f60b93558a8cfe778205d24d451@139.99.173.66:26656#0c0702ee0b2c1095645fc3acc5de92bcdfdbbf6c9e906a1d0e8985a14ac0438d
tcp://19d178d7e0abd8b38feb879c3130f66ad8c937e9@49.13.237.193:26656#8239cf70aba2791020c2af741476da624445be6c6d27055875be19c79018b92e
tcp://6133bdbe3a422dfe9a4907f925344f2fb052f43e@37.27.83.17:26656#8ffc80302e1d26cb992a3979692e55caa704d2f0dd1a8dbf146b34ae225a3aae
tcp://bf125712d80761374f6fa6191f3c805a1923fca7@139.99.172.5:26656#aa1d7efb277b44348b44d967beee3064c55c4f2deb8a35799fe823f8eee4bece
tcp://6b56dfbbef7b0bf3e2217dcfa8746b1b185d8e55@134.255.182.187:26656#74056fe5b57c33612cc688a2d3053273d40baa36cbf0ef2ba29e096e1377302f
tcp://f232a6240d11e589ee4c86c88bfe66d53cb2bcf6@142.132.165.149:26656#fcfeda90d7d1937652bf8123e7d130141048fbfe52cf2fb587b9aad4b6ef810f
tcp://f10751e678768885ef1dfa1d8d299e914ac5931d@193.203.15.209:26656#2793b8cfe8a204ca782b9a2a72bcc0765edd0ddf17ef305b3f2d416c12c4498f
tcp://22808539fbd39cdba9cf5620f44bd115b65edca1@192.175.127.198:26656#f46c5b8627939527541e293b16ad035fdc79d282e328c412fb80c1133ba593af
tcp://1603960a47322033b09c989d2f37ad2fdfa51a48@37.27.67.163:26656#4c2e231fe2732724651d0fd8c5db6a37e2f689c47170cffc52eabb8318d227ef
tcp://79ec25bf51ad09c3b4e6435e3e6d22e864ab690b@198.7.115.43:26656#64c9c11cfe31be3c1fec56ffb2a756cb352c164f3fce1c0a9f991ab797b20d90
tcp://74cff51faec23bf56abf53c8b99b6ec4073edc96@70.34.206.123:26656#2d80ca81d3ce72365889060a9c5dcc30b04e7075f589552739188ecac01b01d0
tcp://f1ca0cb0f3d9ef46af826badc4a1d8ae9426320b@163.172.20.205:26656#d9301d2e636194bfa3e68aa1aa2ea85d08e2957875edcb5e7f4314bfdde9edd0
tcp://8b81d0ff051b5576b2e8009004e457c349ac17d0@65.108.74.78:26656#c418f3897f923d8b5e1c5087b552e38cfde15292299ac4de0fc415be0ed08230
tcp://ab0e0843fdb0632b4fd3de7c12e692972d0954c1@51.83.191.208:26656#ce99b1297bf30cd84ce448c08fba3580981febb9929d8baf271d5e53daf2ea70
tcp://0a77eccd7aa0be2bba74cba55854a5a72397724e@108.61.165.170:26656#3d1babd752d50c51084b8ab7f719b391d482e7417e162970ccdd06f49d9512b0
tcp://eec59e9ae8cc388b2286075b0c8e4f221f112a79@157.10.199.79:26656#70e8aeea3bd08d782eeeeb771ec4cabe6cac105d2ff4b78c06b2e07ca698fed0
tcp://1146bcff061ef104cca3832f4781de58b6b26f0b@95.217.187.31:26656#6ee0be87042267b34f8867626a580aa190d6afe3306b3ddfb97d3a0fb6f596f0
tcp://8abf395fff534f9f952082e4aca81a9b6df8a963@31.220.88.116:26656#f185950e61fe261ac02c02efcc3f3851300c81cac64621edfc8726d5a0f1a310
tcp://8b4e3231c7387be7bdcdd4f47193d4f8ea9362ce@37.27.67.164:26656#0c00d16531a1ca3012ca4b29f8e3474c5378afcc3f1a671030de16f9dcecf350
tcp://9f188bb055fb5dc017c8c25142e4916f9d86ac2c@31.220.85.180:26656#114edaf079b652b35d82ec35180ff8145834c36e1b7e49ca307613fc994ff750
tcp://102c13b35eb55447a468204df7bbf252c54810c0@157.10.199.82:26656#192e7cd62fbfe2bbf7d9a5972c209883e65332b5b860a64236b79268baa9d051
tcp://3cae0adf74d5eee344457fae3a5bea71e53b580e@91.107.226.241:26656#db8688d31781cf8cbe39dbe2dd5fcb7b3cc172adefc8782317352a4018be75d1
tcp://4b19118bf62250d8bd1f65f25578d0949abf9397@167.88.169.16:26656#60869d88c31ba5f5869f2e3b072288f5523a90b7b276f595d2d067c15bb33e91
tcp://313062e54273aa6295945ee254f822af954d6679@216.238.99.9:26656#0a1dc4c81b3ba19229f698e454dc41ee9832343fbe9e9a4fbf8a91b4dc39c291
tcp://81bd1d1e8cac17268cfc1496bc2fbd5790697026@62.169.17.112:26656#7afccfe4be5bca95906efd36c2e887dc64b74cc7548c3f3478c9656ef39d3b11
tcp://@164.90.165.192:#d15afeaea40025ac58f20e77d4f37931a35dca95fb5a0deb5ccbd85d39544391
tcp://f40df8fa5c8d0cbf95a8dea76814eb6e45e4322d@52.10.213.198:26656#328db6689ae2d4b51244325bff23d17209def29fa3a18dcbf72395f09f1820f2
tcp://849d52a31a19dcdfda3a18ffbd70ce341c625e06@149.28.201.164:26656#007a7d6e5fc0adca9dab24584a03dabfcd4d907d811e4b69aa3bf2f9cdd80232
tcp://08d0e40a4784fa85d619906cef437b2f108f41e1@37.60.236.161:26656#ffa4a74c58aa0002696df1a7d2562b5a36f5116581a0df1a91500a9664985f52
tcp://c8df58d1e3cc66201cd019986de7c4a242bb4628@49.13.193.251:26656#0e9a4f75c4bb0ceea1eec28e2b730d81c192a5c386c46886ec48bdceaa8d3ff2
tcp://e6d827fc1f87b1be8fd2662230c66b845883f3c7@46.254.241.9:26656#f513574b70a029ef1f482cf31a7a338e7fb1a7b0337929a0dd3a480eb9faa4b3
tcp://@138.68.73.19:#01d6c9b8661fc28a4aa09ede7948d6253c29a641da38c2be4559b5c22df23933
tcp://689aa19ceccdd7cbb67954ad524680f3019301ba@185.215.167.70:26656#aea18dc0d503713e87eb2e6a24636b66dde356dc597210bed08975be14e37db3
tcp://ce14a7c74b45f7207c505ecd4964587d43c67918@65.108.74.75:26656#092828edc081d3ba1a54f043259b941368f2c718881b06a9d347883b21bfe313
tcp://c8870c00c4fcac34df6fabc5fa8970ee35c18221@45.77.99.172:26656#db5d1d4ad81f1f735bb6cc2561a9c1eabb1a3cd20395508f4fdb36f70ebd4f53
tcp://5e2e5f252d800434df16e1c0da35cff3fd7e190b@95.179.241.182:26656#4eba7299acd923212f9ff9faefda1c8268ff2366faf4099cc36fd0db403703b3
tcp://852a76ede27b0ed1ac5c85776135404c107c9ae5@95.216.146.18:26656#706b871255d45be704983d89207ff0844c281e34f8e87e45f8ae173270deb354
tcp://19586c82f618a2011128ef989c11e48f8fb3b14f@109.199.123.10:26656#110c7c7bc6d52cdded570a6e3bded9b957fcb2bc68f1f6045ebd61ebe51b0bf4
tcp://90d6833f86c9c822615e4988ece3ea288200d119@158.220.80.239:26656#5d464a29e7dba9da33898515d8b45db2c3702f4c909e19de43f7ae77c190c8f5
tcp://52e0f3de9e5859542c3f1ae2348c6a5197968a1e@194.163.143.174:26656#43c94cb00d47132db6595cc88f08a4ac2af5e3f8faf9adc00a791f1e8cd70515
tcp://999e660c07fdcdc6e9a58faf3339d549d44142c1@185.194.216.84:26656#02ea5d030da10c84ad09ca95289c28d6affe7cd40947ad30fa11fc782c677d75
tcp://cd5d5675a3d36c2be6b2d6a07ea56dea4e2e91c8@31.220.84.93:26656#b2deadd3bda2551a39b99a868e8f4558c9a9ece2ff80b4361816f1d1a46cd1f5
tcp://cc8c8166bfdbb3502b3d29ad93500b08560f0856@185.197.250.227:26656#035d2fa64db2b9a59aa90445dc84499e4911fc75b382a9b83682a5e8cbba6a15
tcp://7d2bc55516c3ff079a29f2c8dd42a13fe4b42f5e@149.28.247.165:26656#a116c0ec761f0542919fbf226b4c8d77a57ef064e09df201dfe9aacb0d9018b6
tcp://8c29089f6db3715944e0d81ecff8106015b22496@51.89.216.210:26656#e5d857b3d1cfa3728be68f34f7592cb1f4318367b4549affaf2cd0cb3e47e516
tcp://d5977552a876985eb324f090d837c1c99c7b78e2@213.199.34.251:26656#5348f5464e85cfea9cb003c41c07fcd20a138310d77fc97a3a98119570d89df6
tcp://9b985ed306278358910a58f727f4cc2519ca95a5@108.160.135.149:26656#61569ed796c4e1e3e1f1cf34306526ab967feb916242cf9e9b251206fed9f656
tcp://8d28c4e42aef4b7458a70250842b912ec3574111@167.235.146.99:26656#d658d6d6373a78836efb6a7f403e2d8d01f7b7b1d14966c7af2db9785e2c9796
tcp://205ad11dc08ec4495572736d1c655891018e676a@194.135.93.236:26656#be1cfde128dcfb63035219b03cee7ef3c7cd9c483224dc811e8db64a907a7c57
tcp://f5201d1665e0dbb9118baccc7bcc309a37d553b6@91.107.204.136:26656#edd39830c5f42cae9c259f4bd4f26646c3cca5b08f292e51dcf8bf3c24ea60f7
tcp://08f76ab6c1ca63788e9597730b4232429d1f35c6@64.176.35.235:26656#25a8b283b81a0c3b2b3462cffa660b19ee6fcbfe116013705c498fed1bd52637
tcp://765b0cf7070d38920b13c8024a1d59fe9aed5c13@167.179.90.255:26656#b5c4d7bba1b11f98497c419c4d81b72a525fe30ae788028c570dd4eb77255e77
tcp://07b703a3399ed181a393853cb0011f739c122c1e@157.66.81.130:26656#24dc24a79e14ecfc945e04d8a69e6d0ef922f43cc166c1dfbc6a22a448bb4397
tcp://f6dee245200165e103f5dcde2bc1b4f9cc30bc3f@157.10.199.125:26656#8954a426836f71a0a04e8321cb3b3487ed404790ca19d29419d15cac02de4038
tcp://10bde186929db1c95b513d1004d347c4435efd43@46.254.241.8:26656#edf362e55eafda494d9c5aa28a8332dc1bcc67b324d24ec2665dd92e66e51898
tcp://4c90c9f99f571a8e4b0e33dbd385b83691012782@49.12.102.105:26656#f1616a597eac912c0db8b4696ec11b2c004a421d77a4ff599f6b13654f5a88f8
tcp://267050cc7d6a92e26d3446fee3265d313e00f02b@134.255.182.189:26656#e0e7f6b2961b8f5d2634b71a72846baab89bd6b9b842e6cfd7da9a60aecbcdb8
tcp://bf9c4973ba579814abcb848371a33f7ccba0dd4f@81.17.101.141:26656#ab65e314b9d04d6bb066fac4d35e62f74ac8f52a4c1134301354428dffb949d8
tcp://61fa724b4cfe54f56634866b3bf5455f81b9ad27@65.108.74.79:26656#d014f16e0dc12e9be9de52d52b2eb57d6427a13072f7a9bfe1d761808b0876d8
tcp://63670a3a65f2d3df548f5b7cdc06353cfee0196a@65.109.65.126:26656#13498142da3ff383acabe5f3dbf161b51fe65913ee73d2c38e98e6dd73b54b38
tcp://66bcb448672ba345ffe687e84f20022edadcf263@64.23.134.67:26656#ec61536f25506db52ea25fd10f688d01e29bb0becd5cf8dfa928e16a94d13778
tcp://e78a0b32533115816a01e3b96051ef5a68ada654@54.69.95.118:26656#e5d14cd81686e0ccc081470caf59e6ce4ed1925816d26ad66ff76b00e9f29c59
tcp://c3a59de424b8205f485871f676b8b4c93b01053a@49.13.154.121:26656#62472f43d140786abf3ea0a02f5d9879604ffe7f9552529015bff335c3382159
tcp://@209.38.232.103:#b86a2503a0b765abfaac30739bbfd0fd01bbe80b375cd41f76f35972b7b069f9
tcp://b77f4e54a5639302286497d3c36874c96736a90f@82.211.25.69:26656#66f0010300337221360cd477c898275ea48ca411dd7e04f7a2838e1b39cf82b9
tcp://3faedc3972d46af963279d7b217a50bff7a161c9@93.190.140.111:26656#71f33163403d54af9402b5e9e46384b2f828120f0ec9d370cc08b3aec4e92fd9
tcp://f7db7a5794a1e7b06b8e697c8d6cf108da02773e@93.190.140.114:26656#47aab8e3800b1ce84577bea9e92c602794de4810d75caedaef264e03804ad41a
tcp://ce84a5ca66bb9bcee40657559d22e17a7a45bd81@195.201.238.55:26656#e78966d144d820782ab9f8175f4e4cbb4ad600f45c679d8710070ca8ed7cdc1a
tcp://bca99907b2697d25503089b139c45c07533006f0@135.181.110.216:26656#12f35c3050a1e08b9a79002218a0f5f7b2e9709cf82cfdf9ab04c74dbd16cc5a
tcp://fed1007c668b46abc06dedb423d1adca933bce56@45.76.141.74:26656#52882407701dbd3b1b73e37c05225908938785da21470c67f61897c62dd4509a
tcp://a880c1440927c4fc62774c7674eac6d06b039dce@109.199.123.11:26656#a61e0dddd59e515ca750b3f9b9627fa4bbbff49f8a56c95caef250628772217a
tcp://8ab5d312345ca8b657722edff40ca65101847034@65.21.145.147:26656#2f91eb46842dd12afb2f84418000ccfc583942f52a3334a825519c59cbd3419a
tcp://6911c65adeb15823e08246e280289f093c6b5312@50.116.28.103:26656#c0b811bbe7bad3580506b12ac92f6acac73f35447c6f64685f4daba465be699a
tcp://@157.230.119.88:#787b1ae5f9e86ee76b39bb38fab81424dad6bf052b1ed4510e2cc24b7bd18a9a
tcp://54f2dfed87b54c3ea79902912b74f4c7c3455b6b@188.245.90.255:26656#093c7924743d735ba2f73d6c0dada30babadd8d083fd35106ab31561f850d31a
tcp://7c814f1fa29ae51672f2f319433b835cfb93cdd4@130.162.233.186:26656#272c13b64739b9853979edeece1e3271bf94787122a8a201d253dafa9d4a7b7a
tcp://@46.101.144.237:#97a6990e760ac134ed84d5cb90fa8f4c9d0c49baefac6ce8e26decfcca226fda
tcp://96d883bbe88170ca52446d18f5cab78726a9a0dd@188.208.196.183:26656#26b8c4d88eb8023857a737df91f63167285ca090513e0ea5c341a63d4bf34abb
tcp://6111e285a49c9979ed659fc6265d0db1241a0e57@38.242.224.124:26656#41c180ca7da99171c1c5e983d72172897d78190a68831410f9a786489e6d73bb
tcp://@91.23.167.158:#9455cb290c9c1c53876b815485b359ccb94bf583169569e7eceda09d4af69c5c
tcp://0e3c5652f1ea227798b83403e19c80ce16812e89@178.157.91.184:26656#ea4a6971496f94644600fff68fab26e76c01496415fee28eab224846c558e09c
tcp://c0f6a2e2914f48fb351a7066929c04b708551764@37.60.236.201:26656#542ea6807c3391fc3893bdaefacc14341647af15da0f856bfc323ea2342810fc
tcp://2577d4d04e7c62554b5dbbf442b8785190254988@95.179.139.125:26656#ce6ca219907bdf643803b614dae6e52ca3a2a43910be8d478a0a1d303b987d9c
tcp://4c644b722f2d59cc729699903cd5d8118caf1593@213.199.34.248:26656#0c3774b735180708d90a53d5fc99a2699a9a53cc21cf27505d1a184e1ee836bc
tcp://58d758efd634407e7ca6564f74a9e79f1d434adc@178.157.91.178:26656#3d039ce62023346c62c2fe5f1cacb3a38678a0f54a2817931440d6c8e0856edc
tcp://163bf968457e33c5def35a4a912ddcba11b115d8@213.199.35.18:26656#4bee92fb0fd27a3b23b57f67052d18fd18c6e616935545a6d0e691663c836b9c
tcp://c7d91fa57444d0c1e0f69a36483eddb4579c8506@213.199.35.6:26656#a3a4a419c66b1ee40ee3409ad8b9296b038755ebcc0781f3b8ed63de2c25745d
tcp://f1c717a50ced6d52f82bd3b1b5d3552c7fb6fec4@65.21.147.225:26656#78fc0590dfa8f386b03d3d3a2e9e50b12c138997af115fc4c5347981ed70355d
tcp://22cbcf19e2dc55d7d38c006721e4bc5cbef8577b@37.60.243.59:26656#57f2e758bdf8c592062dbb7b9b13bb1515092eb4856aca8f405fb3e1b098a9dd
tcp://456a0ada76a935af15dc09d2a5fda5d0fd363437@37.27.67.156:26656#28cdae2272c4e52901cb76097e4109ff96d442a9d323f37cd4d325a07a0d49dd
tcp://4f82ff1d16e107d9ab2c67bdcff8c23e767f6b05@37.60.236.247:26656#9433001cb2722bf6620116044f319e7de70dad888a39368c2e0f9fcd317dbe1d
tcp://02665b39f76f9f7df6a5e4bb7f5fa51c8b8862ab@79.137.71.84:26656#b09cfb1d82a643408818d4a02f491a7ed2dc66f074618706221f2f49f2bae0de
tcp://eccf6c009de2acb3a432319bea107bbf16a1913d@159.69.204.162:26656#36b3e63ba54aba9b75994128d124e9e1cebe348cd30415b5098c60526de0157e
tcp://14f1e0ccf8525fa58042e96e01df70d579b2f303@46.254.241.11:26656#34275283d67d69a588edafd85a75a7131775a5f812a419d7608997ed3764df1e
tcp://c1b9318fc837d844968f0ddb178cd037d7f202ac@146.59.4.9:26656#a0c9b5138ac6709cc8220797fe818338788f85378934316d298c03e392d32b1e
tcp://6a8e06e71719d4345e2728fd5e8d586512377041@173.199.71.83:26656#1ff4e7e6f15acb8caa19642e722d62bcfa616d9d7378d18e18f2f88f42a3205f
tcp://0b99d86c0383a9aae6f68293b48f4ea73246ccbb@51.83.70.84:26656#bf86442200d72693d7f1e6bf5fac0325d45fc652bbdbc3be66da142164eecc5f
tcp://23afef249f2159296f3b07db9a478b935392d96d@185.215.166.126:26656#a4313722c75f52e1b2666c099060be756c024c0b237f22b2153f46703515ec5f
tcp://a022ed7f6a435d37729ccb1de39e951310dfc5e7@157.66.81.218:26656#87f398c274ae7f07e7cc86a4a5f5ab6e681be04143556f8df875c1db4473edff
tcp://f78f548407b9d58d9fc54c9ce7b0dc6ac9c7648c@213.199.35.15:26656#bbf2d6a06a186cefc4bdedc1116a61b39b15edaf29de3a1310c36557638642df
tcp://bb0f7022648eaaad15650a0c1a0114125b1b5b28@114.132.172.215:26656#d353cdcae53071401345c38ab482935cb62442be2174a1d3210ca356c9017eff
tcp://d40b15d9b075726b6b6a1bbdd2ea3ea392312783@93.190.140.162:26656#e08e168225f8c14b149b781ecafb320618a5f22c759ba8f8054caba82c78df3f
tcp://26158dfc0162d05173cf1853ad52b9b207d05ba7@65.108.74.109:26656#975f3ed61f5ecb096509aa52b10fdc6a4b3b371d5d22835e393ec2a26ff36b9f
`

func main() {
	deadlock.Opts.Disable = true
	const format = "csv"

	logger, err := log.NewLogger(log.LogLevelDebug, os.Stderr)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Cannot create logger: %v\n", err)
		os.Exit(1)
	}

	ourKey := ed25519.GenPrivKey()

	var addresses = []string{}
	if len(os.Args) == 1 {
		hosts := strings.Split(hosts, "\n")
		for i := range hosts {
			hosts[i] =
				strings.TrimSpace(hosts[i])
		}
		addresses = append(addresses, hosts...)
	} else {
		addresses = os.Args[1:]
	}
	transport := setupTransport(logger)
	defer transport.Close()

	stats := map[string]int{}

	for _, addr := range addresses {
		// Parse validator address, in form: `tcp://nodeID@host:port`
		addrs := strings.Split(addr, "#")
		addr = addrs[0]
		protx := ""
		if len(addrs) > 1 {
			protx = addrs[1]
		}

		validatorAddress, err := types.ParseValidatorAddress(addr)
		if err != nil {
			logger.Error("cannot parse validator address", "address", addr, "err", err)
			report(Stat{protx, validatorAddress, "", err.Error()}, format)
			continue
		}

		version, err := getVersion(logger, transport, validatorAddress, ourKey)
		if err != nil {
			logger.Error("cannot get version", "address", addr, "err", err)
			report(Stat{protx, validatorAddress, "", err.Error()}, format)
			continue
		}

		if version != "" {
			stats[version]++
		}

		report(Stat{protx, validatorAddress, version, ""}, format)
	}
	keyvals := make([]interface{}, 0, len(stats))

	for k, v := range stats {
		keyvals = append(keyvals, k)
		keyvals = append(keyvals, v)
	}
	logger.Info("statistics", keyvals...)
}

func report(stat Stat, format string) {

	switch format {
	case "csv":
		fmt.Printf("'%s','%s','%s','%s'\n", stat.protx, stat.address, stat.version, stat.comment)
	case "prometheus":
		ver, err := semver.NewVersion(stat.version)
		if err == nil {
			fmt.Fprintf(os.Stderr, "cannot parse version %s of node %s: %v\n", stat.version, stat.address, err)
			return
		}
		major := ver.Major()
		minor := ver.Minor()
		patch := ver.Patch()
		isPrerelease := 0
		if ver.Prerelease() != "" {
			isPrerelease = 1
		}

		fmt.Printf("tenderdash_version_major{instance=\"%s\",version=\"%s\"} %d\n", stat.version, stat.address.Hostname, major)
		fmt.Printf("tenderdash_version_minor{instance=\"%s\",version=\"%s\"} %d\n", stat.version, stat.address.Hostname, minor)
		fmt.Printf("tenderdash_version_patch{instance=\"%s\",version=\"%s\"} %d\n", stat.version, stat.address.Hostname, patch)
		fmt.Printf("tenderdash_version_prerelease{instance=\"%s\",version=\"%s\"} %d\n", stat.version, stat.address.Hostname, isPrerelease)
	}
}

func setupTransport(logger log.Logger) *p2p.MConnTransport {
	cfg := conn.DefaultMConnConfig()
	chDesc := []*conn.ChannelDescriptor{}
	opts := p2p.MConnTransportOptions{}
	return p2p.NewMConnTransport(logger, cfg, chDesc, opts)
}

func getVersion(_logger log.Logger, transport *p2p.MConnTransport, val types.ValidatorAddress, ourKey ed25519.PrivKey) (string, error) {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	addr, err := val.NetAddress()
	if err != nil {
		return "", fmt.Errorf("cannot parse address: %w", err)
	}

	endpoint := p2p.Endpoint{
		Protocol: "tcp",
		IP:       addr.IP,
		Port:     addr.Port,
	}
	conn, err := transport.Dial(ctx, &endpoint)
	if err != nil {
		return "", fmt.Errorf("cannot dial: %w", err)
	}

	ourInfo := types.NodeInfo{
		NodeID: types.NodeIDFromPubKey(ourKey.PubKey()),
		ProtocolVersion: types.ProtocolVersion{
			P2P:   version.P2PProtocol,
			Block: version.BlockProtocol,
			App:   1,
		},

		ListenAddr: "127.0.0.1:26656",
		Network:    "dash-1",
		Version:    "1.2.0",
		Channels:   sync.NewConcurrentSlice[uint16](0xf0, 0x0f),
		Moniker:    "version-checker",
	}

	peerInfo, _, err := conn.Handshake(ctx, 5*time.Second, ourInfo, ourKey)
	if err != nil {
		return "", fmt.Errorf("handshake failed: %w", err)
	}
	conn.Close()

	return peerInfo.Version, nil
}

type Stat struct {
	protx   string
	address types.ValidatorAddress
	version string
	comment string
}
